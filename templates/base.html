<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Mi Sitio Web{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div id="dynamic-page-background"></div> <!-- Nuevo contenedor para el fondo dinámico -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="https://www.twitch.tv/aupachus" target="_blank" rel="noopener noreferrer" aria-label="Ir al perfil de Twitch">Aupachus</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link {% if current_endpoint == 'home' %}active{% endif %}"
                           href="{{ url_for('home') }}"
                           {% if current_endpoint == 'home' %}aria-current="page"{% endif %}>Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if current_endpoint == 'galeria' %}active{% endif %}"
                           href="{{ url_for('galeria') }}"
                           {% if current_endpoint == 'galeria' %}aria-current="page"{% endif %}>Galería de fotos</a>
                
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if current_endpoint == 'ver_pdfs' %}active{% endif %}"
                           href="{{ url_for('ver_pdfs') }}"
                           {% if current_endpoint == 'ver_pdfs' %}aria-current="page"{% endif %}>Aprende</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if current_endpoint == 'social' %}active{% endif %}"
                           href="{{ url_for('social') }}"
                           {% if current_endpoint == 'social' %}aria-current="page"{% endif %}>Lanzadera</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if current_endpoint == 'enlaces' %}active{% endif %}"
                           href="{{ url_for('enlaces') }}"
                           {% if current_endpoint == 'enlaces' %}aria-current="page"{% endif %}>Enlaces</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if current_endpoint == 'cursos' %}active{% endif %}"
                           href="{{ url_for('cursos') }}"
                           {% if current_endpoint == 'cursos' %}aria-current="page"{% endif %}>Cursos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if current_endpoint == 'opinion' %}active{% endif %}"
                           href="{{ url_for('opinion') }}" 
                           {% if current_endpoint == 'opinion' %}aria-current="page"{% endif %}>¿Y tú qué opinas?</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://basquesource.blogspot.com/2025/05/basque-source-first-commit.html" target="_blank" rel="noopener noreferrer">BLOGGER</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://discord.gg/VtA2mXkRBT" target="_blank" rel="noopener noreferrer">DISCORD</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Contenedor para la imagen y el botón desplegable de GitHub - AHORA EN BASE.HTML -->
    <!-- Lo posicionaremos de forma fija para que no afecte el flujo del contenido -->
    <div id="avatar-animation-container" style="position: fixed; top: 80px; right: 20px; z-index: 1000; width: auto; height: auto;">
        <!-- Imagen con movimiento Arkanoid (será la base de la animación) -->
        <img id="arkanoid-avatar"
             src="{{ url_for('static', filename='img/1(11).png') }}"
             alt="Aupachus"
             class="img-fluid rounded-circle"
             style="position: fixed; width: 250px; height: 250px; cursor: pointer; z-index: 1001;"
             loading="lazy">

        <!-- Botón Desplegable de GitHub (se posicionará relativo al avatar principal vía JS) -->
        <div class="dropdown" id="github-dropdown-container" style="position: fixed; z-index: 1002; visibility: hidden;">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="githubDropdownBase" data-bs-toggle="dropdown" aria-expanded="false">
                GitHub
            </button>
            <ul class="dropdown-menu" aria-labelledby="githubDropdownBase">
                <li><a class="dropdown-item" href="https://aupachus.github.io/HACKENVIRONMENT/" target="_blank" rel="noopener noreferrer">Hackenvironment</a></li>
                <li><a class="dropdown-item" href="https://aupachus.github.io/web2/#top" target="_blank" rel="noopener noreferrer">Web2</a></li>
                <li><a class="dropdown-item" href="https://aupachus.github.io/RUTAS-PAIS-VASCO/" target="_blank" rel="noopener noreferrer">Rutas-pais-vasco</a></li>
            </ul>
        </div>

        <!-- BOTÓN DE DONACIONES PAYPAL -->
        <div id="donations-button-container" style="position: fixed; z-index: 1002; visibility: hidden; text-align: center;">
            <form action="https://www.paypal.com/donate" method="post" target="_top">
                <input type="hidden" name="hosted_button_id" value="V8DHJUCE86P88" />
                <input type="image" src="https://www.paypalobjects.com/es_ES/ES/i/btn/btn_donateCC_LG.gif" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Botón&nbsp;Donar con PayPal" />
                <img alt="" border="0" src="https://www.paypal.com/es_ES/i/scr/pixel.gif" width="1" height="1" />
            </form>
        </div>
    </div>

    <!-- Contenido principal -->
    <div class="container mt-4">
        {% block content %}
        {% endblock %}
    </div>

    <!-- Bootstrap JS (Bundle incluye Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Datos para JavaScript -->
    <script>
        const APP_TRACKS = [
            {%- for track in music_tracks -%}
                "{{ url_for('static', filename=(audio_folder_name + '/' + track.filename)) }}"{%- if not loop.last -%},{%- endif -%}
            {%- endfor -%}
        ];
        // URLs completas para las imágenes de fondo/galería
        const APP_BACKGROUND_IMAGE_URLS = [
            {%- for image_filename in background_images -%}
                "{{ url_for('static', filename=(gallery_img_folder_for_url + '/' + image_filename)) }}"{%- if not loop.last -%},{%- endif -%}
            {%- endfor -%}
        ];
    </script>
    <!-- Scripts personalizados -->
    <script src="{{ url_for('static', filename='js/dynamicBackground.js') }}"></script> <!-- Nuevo script para fondo -->
    <script src="{{ url_for('static', filename='js/player.js') }}"></script>
    
    <!-- Script global para la animación de texto y animación de la barra de navegación -->
    <script>
        function animateTextFlyOut(text, targetElement) {
            if (!targetElement || typeof text !== 'string') return;

            const elementRect = targetElement.getBoundingClientRect();
            const container = document.body;
            const computedStyle = window.getComputedStyle(targetElement);
            const baseColor = computedStyle.color;
            const baseFontFamily = computedStyle.fontFamily;
            const baseFontSize = computedStyle.fontSize;

            // Si el elemento no es visible o no tiene dimensiones, no animar
            if (elementRect.width === 0 && elementRect.height === 0 && text.length > 0) {
                // console.warn("Target element for animation is not visible or has no dimensions:", targetElement);
                return;
            }

            const startX = elementRect.left + elementRect.width / 2;
            const startY = elementRect.top + elementRect.height / 2;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char.trim() === '') continue;

                const span = document.createElement('span');
                span.textContent = char;
                span.style.position = 'fixed';
                span.style.left = `${startX}px`;
                span.style.top = `${startY}px`;
                span.style.transform = 'translate(-50%, -50%)'; // Centrar el span en su origen
                span.style.color = baseColor;
                span.style.fontFamily = baseFontFamily;
                span.style.fontSize = baseFontSize;
                span.style.pointerEvents = 'none';
                span.style.zIndex = '10001'; // Asegurar que esté por encima de otros elementos
                span.style.willChange = 'transform, opacity'; // Optimización para el navegador
                container.appendChild(span);

                const flyDuration = (1800 + Math.random() * 1200); // Duración entre 1.8s y 3s
                const angle = Math.random() * Math.PI * 2;
                // Distancia de recorrido (similar a la que te gustó, bastante amplia)
                const distance = Math.min(window.innerWidth, window.innerHeight) * (0.8 + Math.random() * 1.2);
                const endX = Math.cos(angle) * distance;
                const endY = Math.sin(angle) * distance;
                const rotation = (Math.random() - 0.5) * 720; // Rotación aleatoria

                span.animate([
                    { transform: `translate(-50%, -50%) translate(0px, 0px) rotate(0deg)`, opacity: 1 },
                    { transform: `translate(-50%, -50%) translate(${endX}px, ${endY}px) rotate(${rotation}deg)`, opacity: 0 }
                ], {
                    duration: flyDuration,
                    easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)', // Suavizado para efecto natural
                    fill: 'forwards' // Mantiene el estado final de la animación
                }).onfinish = () => {
                    if (span.parentNode) { // Comprobar si el span aún existe antes de removerlo
                        span.remove();
                    }
                };
            }
        }

        // --- NUEVA ANIMACIÓN AVANZADA DEL AVATAR ---
        // Store references to event handlers to remove them later
        let advAvatar_mainAvatarMouseDownHandler, advAvatar_documentMouseMoveHandler, advAvatar_documentMouseUpHandler;
        let advAvatar_mainAvatarMouseEnterHandler, advAvatar_mainAvatarMouseLeaveHandler;
        let advAvatar_windowResizeHandler;

        // Animation state variables
        let advAvatar_mainElement, advAvatar_githubDropdown, advAvatar_donationsButton;
        let advAvatar_duplicatedAvatars = []; // Array of {element, x, y, speedX, speedY}
        let advAvatar_duplicateIntervalId, advAvatar_explosionTimeoutId;
        let advAvatar_mainAnimFrameId, advAvatar_duplicatesAnimFrameId;

        let advAvatar_isPausedByHover = false;
        let advAvatar_isDragging = false;
        let advAvatar_posX, advAvatar_posY, advAvatar_speedX, advAvatar_speedY;
        let advAvatar_width, advAvatar_height;
        let advAvatar_dragOffsetX, advAvatar_dragOffsetY;

        const ADVAVATAR_MAX_DUPLICATES = 40;

        function advAvatar_cleanupPreviousAnimation() {
            if (advAvatar_mainElement) {
                advAvatar_mainElement.removeEventListener('mousedown', advAvatar_mainAvatarMouseDownHandler);
                advAvatar_mainElement.removeEventListener('mouseenter', advAvatar_mainAvatarMouseEnterHandler);
                advAvatar_mainElement.removeEventListener('mouseleave', advAvatar_mainAvatarMouseLeaveHandler);
                advAvatar_mainElement.style.cursor = 'pointer';
                advAvatar_mainElement.style.transform = 'scale(1)';
            }
            document.removeEventListener('mousemove', advAvatar_documentMouseMoveHandler);
            document.removeEventListener('mouseup', advAvatar_documentMouseUpHandler);
            window.removeEventListener('resize', advAvatar_windowResizeHandler);

            clearInterval(advAvatar_duplicateIntervalId); advAvatar_duplicateIntervalId = null;
            clearTimeout(advAvatar_explosionTimeoutId); advAvatar_explosionTimeoutId = null;
            cancelAnimationFrame(advAvatar_mainAnimFrameId); advAvatar_mainAnimFrameId = null;
            cancelAnimationFrame(advAvatar_duplicatesAnimFrameId); advAvatar_duplicatesAnimFrameId = null;

            advAvatar_duplicatedAvatars.forEach(dupData => {
                if (dupData.element && dupData.element.parentNode) {
                    dupData.element.remove();
                }
            });
            advAvatar_duplicatedAvatars = [];

            advAvatar_isPausedByHover = false;
            advAvatar_isDragging = false;
        }

        function advancedAvatarAnimation() {
            advAvatar_cleanupPreviousAnimation(); 

            advAvatar_mainElement = document.getElementById('arkanoid-avatar');
            advAvatar_githubDropdown = document.getElementById('github-dropdown-container');
            advAvatar_donationsButton = document.getElementById('donations-button-container');

            if (!advAvatar_mainElement) {
                return;
            }
            advAvatar_mainElement.style.opacity = '1';
            advAvatar_mainElement.style.visibility = 'visible';
            advAvatar_mainElement.style.cursor = 'pointer';
            advAvatar_mainElement.style.transform = 'scale(1)';

            advAvatar_width = advAvatar_mainElement.offsetWidth;
            advAvatar_height = advAvatar_mainElement.offsetHeight;
            
            if (advAvatar_width === 0 || advAvatar_height === 0) {
                const style = window.getComputedStyle(advAvatar_mainElement);
                advAvatar_width = parseInt(style.width, 10) || 250; 
                advAvatar_height = parseInt(style.height, 10) || 250;
            }

            advAvatar_posX = Math.random() * (window.innerWidth - advAvatar_width);
            advAvatar_posY = Math.random() * (window.innerHeight - advAvatar_height);
            advAvatar_posX = Math.max(0, Math.min(advAvatar_posX, window.innerWidth - advAvatar_width));
            advAvatar_posY = Math.max(0, Math.min(advAvatar_posY, window.innerHeight - advAvatar_height));
            
            advAvatar_mainElement.style.left = `${advAvatar_posX}px`;
            advAvatar_mainElement.style.top = `${advAvatar_posY}px`;

            advAvatar_speedX = (Math.random() - 0.5) * 6;
            advAvatar_speedY = (Math.random() - 0.5) * 6;

            function advAvatar_updateMainPosition() {
                if (advAvatar_isDragging || advAvatar_isPausedByHover) {
                    return; 
                }

                advAvatar_posX += advAvatar_speedX;
                advAvatar_posY += advAvatar_speedY;

                if (advAvatar_posX <= 0 || advAvatar_posX >= window.innerWidth - advAvatar_width) advAvatar_speedX *= -1;
                if (advAvatar_posY <= 0 || advAvatar_posY >= window.innerHeight - advAvatar_height) advAvatar_speedY *= -1;

                advAvatar_posX = Math.max(0, Math.min(advAvatar_posX, window.innerWidth - advAvatar_width));
                advAvatar_posY = Math.max(0, Math.min(advAvatar_posY, window.innerHeight - advAvatar_height));

                advAvatar_mainElement.style.left = `${advAvatar_posX}px`;
                advAvatar_mainElement.style.top = `${advAvatar_posY}px`;

                if (advAvatar_githubDropdown) {
                    advAvatar_githubDropdown.style.left = `${advAvatar_posX + advAvatar_width / 2 - advAvatar_githubDropdown.offsetWidth / 2}px`;
                    advAvatar_githubDropdown.style.top = `${advAvatar_posY + advAvatar_height}px`;
                    advAvatar_githubDropdown.style.visibility = 'visible';
                }
                if (advAvatar_donationsButton) {
                    let githubDropdownHeight = 0;
                    if (advAvatar_githubDropdown && advAvatar_githubDropdown.style.visibility !== 'hidden') {
                        githubDropdownHeight = advAvatar_githubDropdown.offsetHeight;
                    }
                    const marginTop = githubDropdownHeight > 0 ? 5 : 0; // 5px de margen solo si el dropdown de GitHub es visible y tiene altura
                    advAvatar_donationsButton.style.left = `${advAvatar_posX + advAvatar_width / 2 - advAvatar_donationsButton.offsetWidth / 2}px`;
                    advAvatar_donationsButton.style.top = `${advAvatar_posY + advAvatar_height + githubDropdownHeight + marginTop}px`;
                    advAvatar_donationsButton.style.visibility = 'visible';
                }
                advAvatar_mainAnimFrameId = requestAnimationFrame(advAvatar_updateMainPosition);
            }

            advAvatar_mainAvatarMouseDownHandler = function(e) {
                advAvatar_isDragging = true;
                advAvatar_dragOffsetX = e.clientX - advAvatar_mainElement.getBoundingClientRect().left;
                advAvatar_dragOffsetY = e.clientY - advAvatar_mainElement.getBoundingClientRect().top;
                advAvatar_mainElement.style.cursor = 'grabbing';
                advAvatar_mainElement.style.transform = 'scale(1.1)';

                advAvatar_isPausedByHover = true; 
                
                cancelAnimationFrame(advAvatar_mainAnimFrameId); 
                advAvatar_mainAnimFrameId = null;

                clearTimeout(advAvatar_explosionTimeoutId); advAvatar_explosionTimeoutId = null;
                clearInterval(advAvatar_duplicateIntervalId); advAvatar_duplicateIntervalId = null;
                cancelAnimationFrame(advAvatar_duplicatesAnimFrameId); advAvatar_duplicatesAnimFrameId = null;

                advAvatar_duplicatedAvatars.forEach(dupData => {
                    dupData.element.animate([{ opacity: parseFloat(dupData.element.style.opacity) || 0.7 }, { opacity: 0 }], { duration: 300, easing: 'ease-out' })
                        .onfinish = () => { if (dupData.element.parentNode) dupData.element.remove(); };
                });
                advAvatar_duplicatedAvatars = [];
            };

            advAvatar_documentMouseMoveHandler = function(e) {
                if (!advAvatar_isDragging) return;
                advAvatar_posX = e.clientX - advAvatar_dragOffsetX;
                advAvatar_posY = e.clientY - advAvatar_dragOffsetY;
                advAvatar_posX = Math.max(0, Math.min(advAvatar_posX, window.innerWidth - advAvatar_width));
                advAvatar_posY = Math.max(0, Math.min(advAvatar_posY, window.innerHeight - advAvatar_height));
                advAvatar_mainElement.style.left = advAvatar_posX + 'px';
                advAvatar_mainElement.style.top = advAvatar_posY + 'px';
                if (advAvatar_githubDropdown) {
                    advAvatar_githubDropdown.style.left = `${advAvatar_posX + advAvatar_width / 2 - advAvatar_githubDropdown.offsetWidth / 2}px`;
                    advAvatar_githubDropdown.style.top = `${advAvatar_posY + advAvatar_height}px`;
                }
                if (advAvatar_donationsButton) {
                    let githubDropdownHeight = 0;
                    if (advAvatar_githubDropdown && advAvatar_githubDropdown.style.visibility !== 'hidden') {
                        githubDropdownHeight = advAvatar_githubDropdown.offsetHeight;
                    }
                    const marginTop = githubDropdownHeight > 0 ? 5 : 0;
                    advAvatar_donationsButton.style.left = `${advAvatar_posX + advAvatar_width / 2 - advAvatar_donationsButton.offsetWidth / 2}px`;
                    advAvatar_donationsButton.style.top = `${advAvatar_posY + advAvatar_height + githubDropdownHeight + marginTop}px`;
                }
            };

            advAvatar_documentMouseUpHandler = function() {
                if (advAvatar_isDragging) {
                    advAvatar_isDragging = false;
                    advAvatar_mainElement.style.cursor = 'pointer';
                    advAvatar_mainElement.style.transform = 'scale(1)';
                    advAvatar_speedX = (Math.random() - 0.5) * 8;
                    advAvatar_speedY = (Math.random() - 0.5) * 8;

                    advAvatar_isPausedByHover = false; 
                    
                    advAvatar_startCycle(); 
                    
                    cancelAnimationFrame(advAvatar_mainAnimFrameId); 
                    advAvatar_updateMainPosition(); 
                }
            };

            advAvatar_mainAvatarMouseEnterHandler = function() {
                if (advAvatar_isDragging) return; 

                advAvatar_isPausedByHover = true;
                cancelAnimationFrame(advAvatar_mainAnimFrameId); 
                advAvatar_mainAnimFrameId = null;

                clearTimeout(advAvatar_explosionTimeoutId); advAvatar_explosionTimeoutId = null;
                clearInterval(advAvatar_duplicateIntervalId); advAvatar_duplicateIntervalId = null;
                cancelAnimationFrame(advAvatar_duplicatesAnimFrameId); advAvatar_duplicatesAnimFrameId = null;

                advAvatar_duplicatedAvatars.forEach(dupData => {
                    dupData.element.animate([{ opacity: parseFloat(dupData.element.style.opacity) || 0.7 }, { opacity: 0 }], { duration: 300, easing: 'ease-out' })
                        .onfinish = () => { if (dupData.element.parentNode) dupData.element.remove(); };
                });
                advAvatar_duplicatedAvatars = [];
            };

            advAvatar_mainAvatarMouseLeaveHandler = function() {
                if (advAvatar_isDragging) return; 

                advAvatar_isPausedByHover = false;
                
                cancelAnimationFrame(advAvatar_mainAnimFrameId); 
                advAvatar_updateMainPosition(); 

                advAvatar_startCycle(); 
            };
            
            advAvatar_windowResizeHandler = () => {
                if (!advAvatar_mainElement) return;
                advAvatar_width = advAvatar_mainElement.offsetWidth;
                advAvatar_height = advAvatar_mainElement.offsetHeight;
                advAvatar_posX = Math.max(0, Math.min(advAvatar_posX, window.innerWidth - advAvatar_width));
                advAvatar_posY = Math.max(0, Math.min(advAvatar_posY, window.innerHeight - advAvatar_height));
                advAvatar_mainElement.style.left = `${advAvatar_posX}px`;
                advAvatar_mainElement.style.top = `${advAvatar_posY}px`;

                if (advAvatar_githubDropdown) {
                     advAvatar_githubDropdown.style.left = `${advAvatar_posX + advAvatar_width / 2 - advAvatar_githubDropdown.offsetWidth / 2}px`;
                     advAvatar_githubDropdown.style.top = `${advAvatar_posY + advAvatar_height}px`;
                }
                if (advAvatar_donationsButton) {
                    let githubDropdownHeight = 0;
                    if (advAvatar_githubDropdown && advAvatar_githubDropdown.style.visibility !== 'hidden') {
                        githubDropdownHeight = advAvatar_githubDropdown.offsetHeight;
                    }
                    const marginTop = githubDropdownHeight > 0 ? 5 : 0;
                    advAvatar_donationsButton.style.left = `${advAvatar_posX + advAvatar_width / 2 - advAvatar_donationsButton.offsetWidth / 2}px`;
                    advAvatar_donationsButton.style.top = `${advAvatar_posY + advAvatar_height + githubDropdownHeight + marginTop}px`;
                }
            };

            advAvatar_mainElement.addEventListener('mousedown', advAvatar_mainAvatarMouseDownHandler);
            document.addEventListener('mousemove', advAvatar_documentMouseMoveHandler);
            document.addEventListener('mouseup', advAvatar_documentMouseUpHandler);
            advAvatar_mainElement.addEventListener('mouseenter', advAvatar_mainAvatarMouseEnterHandler);
            advAvatar_mainElement.addEventListener('mouseleave', advAvatar_mainAvatarMouseLeaveHandler);
            window.addEventListener('resize', advAvatar_windowResizeHandler);

            function advAvatar_updateDuplicatesPosition() {
                if (advAvatar_isPausedByHover || advAvatar_duplicatedAvatars.length === 0) {
                    cancelAnimationFrame(advAvatar_duplicatesAnimFrameId);
                    advAvatar_duplicatesAnimFrameId = null;
                    return;
                }
                
                let hasActiveDuplicates = false;
                advAvatar_duplicatedAvatars.forEach(dupData => {
                    dupData.x += dupData.speedX;
                    dupData.y += dupData.speedY;

                    if (dupData.x <= 0 || dupData.x >= window.innerWidth - dupData.element.offsetWidth) {
                        dupData.speedX *= -1;
                    }
                    if (dupData.y <= 0 || dupData.y >= window.innerHeight - dupData.element.offsetHeight) {
                        dupData.speedY *= -1;
                    }

                    dupData.x = Math.max(0, Math.min(dupData.x, window.innerWidth - dupData.element.offsetWidth));
                    dupData.y = Math.max(0, Math.min(dupData.y, window.innerHeight - dupData.element.offsetHeight));

                    dupData.element.style.left = `${dupData.x}px`;
                    dupData.element.style.top = `${dupData.y}px`;
                    hasActiveDuplicates = true;
                });

                if (hasActiveDuplicates) {
                    advAvatar_duplicatesAnimFrameId = requestAnimationFrame(advAvatar_updateDuplicatesPosition);
                } else {
                    cancelAnimationFrame(advAvatar_duplicatesAnimFrameId);
                    advAvatar_duplicatesAnimFrameId = null;
                }
            }

            function advAvatar_createDuplicate() {
                if (advAvatar_isPausedByHover) return;

                if (advAvatar_duplicatedAvatars.length >= ADVAVATAR_MAX_DUPLICATES) {
                    advAvatar_explodeAvatars();
                    return;
                }
                if (!advAvatar_mainElement) return;

                const duplicate = advAvatar_mainElement.cloneNode(true);
                duplicate.id = ''; 
                duplicate.style.position = 'fixed'; 
                
                duplicate.style.left = `${advAvatar_posX}px`;
                duplicate.style.top = `${advAvatar_posY}px`;
                duplicate.style.opacity = '0.7';
                duplicate.style.transform = `scale(${1 - advAvatar_duplicatedAvatars.length * 0.02})`; 
                duplicate.style.zIndex = 1000 - (advAvatar_duplicatedAvatars.length + 1); 
                
                const dupData = {
                    element: duplicate,
                    x: advAvatar_posX,
                    y: advAvatar_posY,
                    speedX: (Math.random() - 0.5) * 4, 
                    speedY: (Math.random() - 0.5) * 4  
                };

                document.body.appendChild(duplicate); 
                advAvatar_duplicatedAvatars.push(dupData);

                if (advAvatar_duplicatedAvatars.length === 1 && !advAvatar_duplicatesAnimFrameId) { 
                    cancelAnimationFrame(advAvatar_duplicatesAnimFrameId); 
                    advAvatar_updateDuplicatesPosition();
                }
            }

            function advAvatar_explodeAvatars() {
                clearInterval(advAvatar_duplicateIntervalId); advAvatar_duplicateIntervalId = null;
                advAvatar_duplicatedAvatars.forEach(dupData => {
                    dupData.element.animate([
                        { transform: dupData.element.style.transform + ' translate(0,0)', opacity: parseFloat(dupData.element.style.opacity) || 0.7 },
                        { transform: dupData.element.style.transform + ` translate(${(Math.random()-0.5)*200}px, ${(Math.random()-0.5)*200}px) scale(0)`, opacity: 0 }
                    ], { duration: 588, easing: 'ease-out' }).onfinish = () => {
                         if(dupData.element.parentNode) dupData.element.remove();
                    };
                });
                advAvatar_duplicatedAvatars = [];
                if (!advAvatar_isPausedByHover) { 
                    advAvatar_explosionTimeoutId = setTimeout(advAvatar_startCycle, 882);
                }
            }

            function advAvatar_startCycle() {
                if (advAvatar_isPausedByHover) return; 

                clearTimeout(advAvatar_explosionTimeoutId); advAvatar_explosionTimeoutId = null;
                clearInterval(advAvatar_duplicateIntervalId); 
                
                if (advAvatar_mainElement) advAvatar_mainElement.style.opacity = '1';
                
                if (advAvatar_mainElement && !advAvatar_isPausedByHover) { 
                     advAvatar_duplicateIntervalId = setInterval(advAvatar_createDuplicate, 2000);
                }
            }

            advAvatar_updateMainPosition();
            advAvatar_startCycle();
        }
        // --- FIN NUEVA ANIMACIÓN AVANZADA DEL AVATAR ---

        document.addEventListener('DOMContentLoaded', function() {
            const navBarLinks = document.querySelectorAll('.navbar-nav .nav-link');
            if (navBarLinks.length > 0) {
                navBarLinks.forEach((link, index) => {
                    const originalLinkText = link.textContent.trim();
                    if (originalLinkText !== '' && !link.classList.contains('dropdown-toggle') && !link.querySelector('img') && !link.querySelector('i')) {
                        const baseIntervalTime = 15000 + (Math.random() * 10000); // Intervalo largo (15-25s)
                        setTimeout(() => {
                            setInterval(function() {
                                if (document.body.contains(link) && getComputedStyle(link).display !== 'none') {
                                    animateTextFlyOut(originalLinkText, link);
                                }
                            }, baseIntervalTime);
                        }, index * 1200 + Math.random() * 800); // Inicio escalonado
                    }
                });
            }

            // Iniciar la nueva animación del avatar
            advancedAvatarAnimation();

            // Efecto de explosión de letras al pasar el ratón sobre elementos de texto elegibles
            const hoverAnimatedElementsCooldown = new Set(); // Para el enfriamiento

            document.body.addEventListener('mouseover', function(event) {
                let target = event.target;

                // Si el objetivo directo es un nodo de texto, usar su elemento padre
                if (target.nodeType === Node.TEXT_NODE) {
                    target = target.parentElement;
                }

                // Asegurarse de que el objetivo es un HTMLElement
                if (!(target instanceof HTMLElement)) {
                    return;
                }

                // Selectores para elementos elegibles (ajusta según sea necesario)
                const eligibleSelectors = [
                    'p',
                    'h1:not(.animated-title)', // Excluir títulos principales con animación propia
                    'h2:not(.animated-title)',
                    'h3:not(.animated-title)',
                    'h4', 'h5', 'h6',
                    'li',
                    'span:not(.navbar-toggler-icon)', // Spans generales, excluyendo iconos de Bootstrap
                    'a', // Hacer elegibles los enlaces genéricos
                    'td', 'th', // Celdas de tablas
                    'label:not([for="trackSelector"]):not([for="volumeControl"])',
                    // Añadir elementos comunes de formato en línea
                    'strong', 'em', 'b', 'i', 'u', 'small', 'mark'
                ].join(',');

                // Selectores para elementos a excluir explícitamente
                const exclusionSelectors = [
                    '.navbar-nav .nav-link', // Ya tienen animación temporizada
                    'a[href^="mailto:"]',    // Ya tiene animación temporizada
                    'h1.animated-title',     // Ya tiene animación temporizada
                    'div.text-center:last-of-type > a.btn', // Botones de sección en index.html
                    '.navbar-brand', // Excluir el brand de la navbar
                    '#translatable-welcome-text p', // El bloque de bienvenida tiene animación de caída
                    '#githubDropdown', '.dropdown-item', // Menú desplegable de GitHub
                    '#prevButton', '#playButton', '#nextButton', '#stopButton', // Botones del reproductor
                    '#trackSelector', '#volumeControl', // Controles del reproductor
                    'button[data-lang]', // Botones de traducción
                    '.learning-btn', // Excluir botones de aprendizaje de index.html
                    '.learning-btn-pdf', // Excluir botones de aprendizaje de pdfs.html
                    '.btn', // Excluir botones genéricos para evitar conflictos (algunos ya están cubiertos)
                    'script', 'style', 'textarea', 'input', 'select', 'option', 'button' // Elementos no textuales o interactivos
                ].join(',');

                if (target.matches(eligibleSelectors) && !target.closest(exclusionSelectors)) {
                    const textToAnimate = target.textContent;
                    if (textToAnimate && textToAnimate.trim() !== '') {
                        if (!hoverAnimatedElementsCooldown.has(target)) {
                            const style = window.getComputedStyle(target);
                            if (style.display === 'none' || style.visibility === 'hidden' || style.opacity === '0') {
                                return; // No animar elementos no visibles
                            }

                            animateTextFlyOut(textToAnimate, target);
                            hoverAnimatedElementsCooldown.add(target);

                            setTimeout(() => {
                                hoverAnimatedElementsCooldown.delete(target);
                            }, 3500); // Tiempo de enfriamiento (un poco más que la duración máx. de la animación)
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>
